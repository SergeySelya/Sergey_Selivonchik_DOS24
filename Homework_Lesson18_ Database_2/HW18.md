## Задание:
Цель: научиться реализовывать отказоустойчивое решение для баз
данных (на примере Postgresql либо MySQL)
Задание 1:
1. Создать два сервера, установить на них PostgreSQL либо MySQL и подключить их к
одной сети.
2. Настроить репликацию между серверами, чтобы изменения, вносимые
на одном сервере, автоматически реплицировались на другой. (Зеркалирование)
3. Настроить отказоустойчивость, используя репликацию и механизм
автоматического переключения между серверами. (Кластер*) Кластер по желанию и по возможности.
4. Проверить работу отказоустойчивого решения, симулируя отказ одного
из серверов и убедившись, что второй сервер продолжает работу и все
данные сохранены с обоими видами репликации (Зеркалирование подразумевает, что реплика автоматически подключится к главное ноде в случае, когда она станет вновь доступна)
Опционально:
● Настроить систему резервного копирования, чтобы регулярно создавать
бэкапы данных и сохранять их на отдельном сервере (либо на отдельном диске, либо папке) через SSH.
● Документировать все шаги по настройке и проверке отказоустойчивого
решения и подготовить отчет о выполненной работе. 

## Решение
# Настройка репликации MySQL между двумя Ubuntu серверами

### Описание
В этом руководстве описана настройка **репликации MySQL** между двумя машинами Ubuntu с использованием зеркалирования данных. Репликация будет настроена с двумя машинами:

- **Машина 1 (Master)**: `54.159.29.27`
- **Машина 2 (Slave)**: `18.234.232.110`
Создаем два сервера ec2 на AWS:
<img width="981" alt="image" src="https://github.com/user-attachments/assets/a9d397fd-d150-490c-a2d9-15039090c5ac" />
Настраиваем Security Groups Master SQL , чтобы Slave SQL могла подключаться и реплецировать данные к себе на сервер
<img width="1094" alt="image" src="https://github.com/user-attachments/assets/4f8bae6c-5786-4391-a2b8-a68002411658" />


### Шаг 1: Установка MySQL на обеих машинах

1. **Обновите пакеты и установите MySQL сервер** на обеих машинах:

    ```bash
    sudo apt update
    sudo apt install mysql-server -y
    ```

2. **Проверьте, что MySQL работает на обеих машинах**:

    ```bash
    sudo systemctl status mysql
    ```

    Если MySQL не запущен, выполните:

    ```bash
    sudo systemctl start mysql
    ```

### Шаг 2: Настройка MySQL на Master-сервере (Машина 1: 54.159.29.27)

1. Добовляем новое правило для UFW, которое будет пропускать соединения с репликой через брандмауэр источника

   ```bash
   sudo ufw allow from replica_server_ip to any port 3306
   # replica_server_ipна фактический IP-адрес вашего сервера-реплики.
   ```
1. **Откройте конфигурационный файл MySQL**:

    ```bash
    sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf 
    ```

2. В файле конфигурации `mysqld.cnf` измените или добавьте следующие параметры:

    ```ini
    # Включение бинарных логов (нужно просто раскоментить)
    log_bin                   = /var/log/mysql/mysql-bin.log 

    # Уникальный ID сервера
    server-id=1

    # Разрешение подключения с любых IP-адресов
    bind-address=0.0.0.0

    # Прописываем те БД которые будем реплицировать
    binlog_do_db = test
    # binlog_do_db      = db_1 - если баз больше одной
    # binlog_do_db      = db_2 - если баз больше одной
    ```

3. **Перезапустите MySQL** на Master-сервере, чтобы применить изменения:

    ```bash
    sudo systemctl restart mysql
    ```

4. **Создайте пользователя для репликации** на Master-сервере:

    Подключитесь к MySQL:

    ```bash
    sudo mysql
    ```

    Создайте пользователя для репликации:

    ```sql
    CREATE USER 'replica_user'@'18.234.232.110' IDENTIFIED WITH mysql_native_password BY 'password';

    GRANT REPLICATION SLAVE ON *.* TO 'replica_user'@'18.234.232.110';

    FLUSH PRIVILEGES;

    # replica_server_ip на публичный IP-адрес сервера реплики
    ```

5. **Получите информацию о текущем статусе Master-сервера**, чтобы узнать `File` и `Position` для Slave-сервера:

    ```sql
    SHOW MASTER STATUS;
    ```

    Запишите значения `File` и `Position` — они понадобятся для настройки Slave-сервера.

    Пример вывода:

    ```plaintext
    +------------------+----------+--------------+------------------+-------------------+
    | File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
    +------------------+----------+--------------+------------------+-------------------+
    | mysql-bin.000346 |     1420 | test         |                  |                   |
    +------------------+----------+--------------+------------------+-------------------+
    ```

    Запишите `File` (например, `mysql-bin.000346`) и `Position` (например, `1420`).

### Шаг 3: Настройка MySQL на Slave-сервере (Машина 2: 18.234.232.110)

1. **Откройте конфигурационный файл MySQL**:

    ```bash
    sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
    ```

2. В файле конфигурации `mysqld.cnf` добавьте или измените следующие параметры:

    ```ini
    # Уникальный ID для Slave-сервера
    server-id=2

    relay-log           = /var/log/mysql/mysql-relay-bin.log

    log_bin             = /var/log/mysql/mysql-bin.log 
    
    binlog_do_db        = test
    ```

3. **Перезапустите MySQL** на Slave-сервере:

    ```bash
    sudo systemctl restart mysql
    ```

4. **Настройка репликации на Slave-сервере**.

    Подключитесь к MySQL на Slave-сервере:

    ```bash
    sudo mysql
    ```

    Выполните следующие команды, чтобы настроить репликацию:

    ```sql
    STOP REPLICA;

    CHANGE REPLICATION SOURCE TO 
    SOURCE_HOST='54.159.29.27', 
    SOURCE_USER='replica_user', 
    SOURCE_PASSWORD='password', 
    SOURCE_LOG_FILE='mysql-bin.000346', 
    SOURCE_LOG_POS=1420;
    
    START REPLICA;
    ```

    Замените `MASTER_LOG_FILE` и `MASTER_LOG_POS` на те значения, которые вы записали из Master-сервера.
    Обязательно замените source_server_ip на IP-адрес исходного сервера. Аналогичным образом, replica_user и password должны соответствовать имени пользователя репликации,

6. **Проверьте статус репликации на Slave**:

    ```sql
    SHOW SLAVE STATUS\G
    ```

    Ищите строки `Slave_IO_Running` и `Slave_SQL_Running`. Если оба значения равны `Yes`, репликация настроена корректно.

    Пример вывода:

    ```plaintext
    Slave_IO_Running: Yes
    Slave_SQL_Running: Yes
    ```
<img width="618" alt="image" src="https://github.com/user-attachments/assets/1c54c9aa-7897-447f-9173-d9eeeb2ec42f" />

### Шаг 4: Проверка репликации

1. На **Master-сервере** создайте таблицу и вставьте данные:

    ```sql
    USE test;
    
    CREATE TABLE example_table ( 
    example_column varchar(30) 
    ); 

    INSERT INTO example_table VALUES 
    ('Первая строка'), 
    ('Вторая строка'), 
    ('Третья строка'); 
    ```
    
<img width="513" alt="image" src="https://github.com/user-attachments/assets/e8ed6123-ffff-48d5-84ec-f7847e085c19" />
2. Проверьте данные на **Slave-сервере**:

    ```sql
    USE test;
    SHOW TABLES;
    ```
    
<img width="465" alt="image" src="https://github.com/user-attachments/assets/4e0b1a08-cdee-4fb9-9adf-49bd3bb30609" />

    Мы можем видеть, что таблица example_table успешно перенеслась

### Шаг 5: Завершение настройки

Теперь репликация между Master и Slave должна работать, и все изменения, внесенные на Master, будут автоматически реплицироваться на Slave.

### Шаг 6: Завершение работы

1. **Проверьте логи** на обоих серверах, чтобы убедиться, что все работает корректно. Логи можно найти в файле `/var/log/mysql/error.log`.

2. **Для автоматического запуска MySQL** при перезагрузке серверов:

    ```bash
    sudo systemctl enable mysql
    ```

---

### Заключение

Теперь у вас настроена репликация между двумя MySQL серверами с зеркалированием данных. Все изменения, внесенные на Master-сервере, автоматически реплицируются на Slave-сервер.
