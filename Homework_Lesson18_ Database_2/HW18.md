## Задание:
Цель: научиться реализовывать отказоустойчивое решение для баз
данных (на примере Postgresql либо MySQL)
Задание 1:
1. Создать два сервера, установить на них PostgreSQL либо MySQL и подключить их к
одной сети.
2. Настроить репликацию между серверами, чтобы изменения, вносимые
на одном сервере, автоматически реплицировались на другой. (Зеркалирование)
3. Настроить отказоустойчивость, используя репликацию и механизм
автоматического переключения между серверами. (Кластер*) Кластер по желанию и по возможности.
4. Проверить работу отказоустойчивого решения, симулируя отказ одного
из серверов и убедившись, что второй сервер продолжает работу и все
данные сохранены с обоими видами репликации (Зеркалирование подразумевает, что реплика автоматически подключится к главное ноде в случае, когда она станет вновь доступна)
Опционально:
● Настроить систему резервного копирования, чтобы регулярно создавать
бэкапы данных и сохранять их на отдельном сервере (либо на отдельном диске, либо папке) через SSH.
● Документировать все шаги по настройке и проверке отказоустойчивого
решения и подготовить отчет о выполненной работе. 

## Решение
# Настройка репликации MySQL между двумя Ubuntu серверами

### Описание
В этом руководстве описана настройка **репликации MySQL** между двумя машинами Ubuntu с использованием зеркалирования данных. Репликация будет настроена с двумя машинами:

- **Машина 1 (Master)**: `3.81.131.135`
- **Машина 2 (Slave)**: `18.208.173.141`
Создаем два сервера ec2 на AWS:
<img width="993" alt="image" src="https://github.com/user-attachments/assets/137da7b2-903e-4e48-8c1f-d6f9724fbbc7" />
Настраиваем Security Groups каждой машины , давая полный доступ трафика к машине по ip.
<img width="1108" alt="image" src="https://github.com/user-attachments/assets/365e239b-ac20-47c6-ab27-8a25e9947da1" />


### Шаг 1: Установка MySQL на обеих машинах

1. **Обновите пакеты и установите MySQL сервер** на обеих машинах:

    ```bash
    sudo apt update
    sudo apt install mysql-server -y
    ```

2. **Проверьте, что MySQL работает на обеих машинах**:

    ```bash
    sudo systemctl status mysql
    ```

    Если MySQL не запущен, выполните:

    ```bash
    sudo systemctl start mysql
    ```

### Шаг 2: Настройка MySQL на Master-сервере (Машина 1: 3.81.131.135)

1. **Откройте конфигурационный файл MySQL**:

    ```bash
    sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
    ```

2. В файле конфигурации `mysqld.cnf` измените или добавьте следующие параметры:

    ```ini
    # Включение бинарных логов
    log-bin=mysql-bin

    # Уникальный ID сервера
    server-id=1

    # Разрешение подключения с любых IP-адресов
    bind-address=0.0.0.0
    ```

3. **Перезапустите MySQL** на Master-сервере, чтобы применить изменения:

    ```bash
    sudo systemctl restart mysql
    ```

4. **Создайте пользователя для репликации** на Master-сервере:

    Подключитесь к MySQL:

    ```bash
    sudo mysql -u root -p
    ```

    Создайте пользователя для репликации:

    ```sql
    CREATE USER 'replica_user'@'%' IDENTIFIED BY 'password';
    GRANT REPLICATION SLAVE ON *.* TO 'replica_user'@'%';
    FLUSH PRIVILEGES;
    ```

5. **Получите информацию о текущем статусе Master-сервера**, чтобы узнать `File` и `Position` для Slave-сервера:

    ```sql
    SHOW MASTER STATUS;
    ```

    Запишите значения `File` и `Position` — они понадобятся для настройки Slave-сервера.

    Пример вывода:

    ```plaintext
    +------------------+----------+--------------+------------------+-------------------+
    | File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |
    +------------------+----------+--------------+------------------+-------------------+
    | mysql-bin.000001 | 154      |              |                  |                   |
    +------------------+----------+--------------+------------------+-------------------+
    ```

    Запишите `File` (например, `mysql-bin.000001`) и `Position` (например, `154`).

### Шаг 3: Настройка MySQL на Slave-сервере (Машина 2: 54.161.233.71)

1. **Откройте конфигурационный файл MySQL**:

    ```bash
    sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
    ```

2. В файле конфигурации `mysqld.cnf` добавьте или измените следующие параметры:

    ```ini
    # Уникальный ID для Slave-сервера
    server-id=2

    # Разрешение подключений с любых IP-адресов
    bind-address=0.0.0.0
    ```

3. **Перезапустите MySQL** на Slave-сервере:

    ```bash
    sudo systemctl restart mysql
    ```

4. **Настройка репликации на Slave-сервере**.

    Подключитесь к MySQL на Slave-сервере:

    ```bash
    sudo mysql -u root -p
    ```

    Выполните следующие команды, чтобы настроить репликацию:

    ```sql
    STOP SLAVE;

    CHANGE MASTER TO
      MASTER_HOST='3.86.212.159',  -- IP-адрес Master-сервера
      MASTER_USER='replica_user',
      MASTER_PASSWORD='password',
      MASTER_LOG_FILE='mysql-bin.000001',  -- `File`, полученный на Master
      MASTER_LOG_POS=154;                 -- `Position`, полученная на Master

    START SLAVE;
    ```

    Замените `MASTER_LOG_FILE` и `MASTER_LOG_POS` на те значения, которые вы записали из Master-сервера.

5. **Проверьте статус репликации на Slave**:

    ```sql
    SHOW SLAVE STATUS\G
    ```

    Ищите строки `Slave_IO_Running` и `Slave_SQL_Running`. Если оба значения равны `Yes`, репликация настроена корректно.

    Пример вывода:

    ```plaintext
    Slave_IO_Running: Yes
    Slave_SQL_Running: Yes
    ```

### Шаг 4: Проверка репликации

1. На **Master-сервере** создайте таблицу и вставьте данные:

    ```sql
    USE test;
    CREATE TABLE test_table (id INT PRIMARY KEY, name VARCHAR(50));
    INSERT INTO test_table (id, name) VALUES (1, 'MasterData');
    ```

2. Проверьте данные на **Slave-сервере**:

    ```sql
    USE test;
    SELECT * FROM test_table;
    ```

    Вы должны увидеть, что данные были автоматически реплицированы на Slave.

### Шаг 5: Завершение настройки

Теперь репликация между Master и Slave должна работать, и все изменения, внесенные на Master, будут автоматически реплицироваться на Slave.

### Шаг 6: Завершение работы

1. **Проверьте логи** на обоих серверах, чтобы убедиться, что все работает корректно. Логи можно найти в файле `/var/log/mysql/error.log`.

2. **Для автоматического запуска MySQL** при перезагрузке серверов:

    ```bash
    sudo systemctl enable mysql
    ```

---

### Заключение

Теперь у вас настроена репликация между двумя MySQL серверами с зеркалированием данных. Все изменения, внесенные на Master-сервере, автоматически реплицируются на Slave-сервер.
